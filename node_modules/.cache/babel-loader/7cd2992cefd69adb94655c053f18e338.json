{"ast":null,"code":"const input = 0;\nconst output = 1;\nconst err = 2;\nconst env = 3;\n\nclass ColonyRuntime {\n  constructor(host, port) {\n    this.crypto = new Crypto();\n    this.host = host;\n    this.port = port;\n  }\n\n  load() {\n    var crypto = this.crypto;\n    let promise = new Promise(function (ok, err) {\n      crypto.load().then(() => {\n        ok();\n      });\n    });\n    return promise;\n  }\n\n  crypto() {\n    return this.crypto;\n  }\n\n  sendRPCMsg(msg, prvkey) {\n    let rpcMsg = {\n      \"payloadtype\": msg.msgtype,\n      \"payload\": \"\",\n      \"signature\": \"\"\n    };\n    rpcMsg.payload = btoa(JSON.stringify(msg));\n    rpcMsg.signature = this.crypto.sign(rpcMsg.payload, prvkey);\n    var host = this.host;\n    var port = this.port;\n    let promise = new Promise(function (resolve, reject) {\n      $.ajax({\n        type: \"POST\",\n        url: \"http://\" + host + \":\" + port + \"/api\",\n        data: JSON.stringify(rpcMsg),\n        contentType: 'plain/text',\n        success: function (response) {\n          let rpcReplyMsg = JSON.parse(response);\n          let msg = JSON.parse(atob(JSON.parse(response).payload));\n\n          if (rpcReplyMsg.error == true) {\n            reject(msg);\n          } else {\n            resolve(msg);\n          }\n        },\n        fail: function (xhr, status, error) {\n          reject(atob(JSON.parse(response).payload));\n        }\n      });\n    });\n    return promise;\n  }\n\n  add_colony(colony, prvkey) {\n    var msg = {\n      \"msgtype\": \"addcolonymsg\",\n      \"colony\": colony\n    };\n    return this.sendRPCMsg(msg, prvkey);\n  }\n\n  getColonies(prvkey) {\n    var msg = {\n      \"msgtype\": \"getcoloniesmsg\"\n    };\n    return this.sendRPCMsg(msg, prvkey);\n  }\n\n  getColony(colonyid, prvkey) {\n    var msg = {\n      \"msgtype\": \"getcolonymsg\",\n      \"colonyid\": colonyid\n    };\n    return this.sendRPCMsg(msg, prvkey);\n  }\n\n  addRuntime(runtime, prvkey) {\n    var msg = {\n      \"msgtype\": \"addruntimemsg\",\n      \"runtime\": runtime\n    };\n    return this.sendRPCMsg(msg, prvkey);\n  }\n\n  rejectRuntime(runtimeid, prvkey) {\n    var msg = {\n      \"msgtype\": \"rejectruntimemsg\",\n      \"runtimeid\": runtimeid\n    };\n    return this.sendRPMsg(msg, prvkey);\n  }\n\n  approveRuntime(runtimeid, prvkey) {\n    var msg = {\n      \"msgtype\": \"approveruntimemsg\",\n      \"runtimeid\": runtimeid\n    };\n    return this.sendRPCMsg(msg, prvkey);\n  }\n\n  submitProcess_spec(spec, prvkey) {\n    var msg = {\n      \"msgtype\": \"submitprocessespecmsg\",\n      \"spec\": spec\n    };\n    return this.sendRPCMsg(msg, prvkey);\n  }\n\n  assign(colonyid, prvkey) {\n    var msg = {\n      \"msgtype\": \"assignprocessmsg\",\n      \"latest\": false,\n      \"timeout\": 1,\n      \"colonyid\": colonyid\n    };\n    return this.sendRPCMsg(msg, prvkey);\n  }\n\n  assignLatest(colonyid, prvkey) {\n    var msg = {\n      \"msgtype\": \"assignprocessmsg\",\n      \"latest\": true,\n      \"timeout\": -1,\n      \"colonyid\": colonyid\n    };\n    return this.sendRPCMsg(msg, prvkey);\n  }\n\n  addAttribute(attribute, prvkey) {\n    attribute.attributetype = output;\n    var msg = {\n      \"msgtype\": \"addattributemsg\",\n      \"attribute\": attribute\n    };\n    return this.sendRPCMsg(msg, prvkey);\n  }\n\n  closeProcess(processid, successful, prvkey) {\n    var msg = {\n      \"msgtype\": \"closesuccessfulmsg\",\n      \"processid\": processid\n    };\n\n    if (successful) {\n      return this.sendRPCMsg(msg, prvkey);\n    }\n\n    msg.msgtype = \"closefailedfulmsg\";\n    return this.sendRPCMsg(msg, prvkey);\n  }\n\n  subscribeProcesses(runtimetype, timeout, state, prvkey, callback) {\n    var msg = {\n      \"msgtype\": \"subscribeprocessesmsg\",\n      \"runtimetype\": runtimetype,\n      \"state\": state,\n      \"timeout\": timeout\n    };\n    let rpcMsg = {\n      \"payloadtype\": msg.msgtype,\n      \"payload\": \"\",\n      \"signature\": \"\"\n    };\n    rpcMsg.payload = btoa(JSON.stringify(msg));\n    rpcMsg.signature = this.crypto.sign(rpcMsg.payload, prvkey);\n    let socket = new WebSocket(\"ws://\" + this.host + \":\" + this.port + \"/pubsub\");\n    socket.addEventListener('open', function (event) {\n      socket.send(JSON.stringify(rpcMsg));\n    });\n    let promise = new Promise(function (resolve, reject) {\n      socket.addEventListener('close', function (event) {\n        socket = null;\n        reject();\n      });\n      socket.addEventListener('error', function (event) {\n        socket = null;\n        reject();\n      });\n      socket.addEventListener('message', function (event) {\n        msg = JSON.parse(atob(JSON.parse(event.data).payload));\n        callback(msg);\n      });\n    });\n    return promise;\n  }\n\n}","map":{"version":3,"names":["input","output","err","env","ColonyRuntime","constructor","host","port","crypto","Crypto","load","promise","Promise","ok","then","sendRPCMsg","msg","prvkey","rpcMsg","msgtype","payload","btoa","JSON","stringify","signature","sign","resolve","reject","$","ajax","type","url","data","contentType","success","response","rpcReplyMsg","parse","atob","error","fail","xhr","status","add_colony","colony","getColonies","getColony","colonyid","addRuntime","runtime","rejectRuntime","runtimeid","sendRPMsg","approveRuntime","submitProcess_spec","spec","assign","assignLatest","addAttribute","attribute","attributetype","closeProcess","processid","successful","subscribeProcesses","runtimetype","timeout","state","callback","socket","WebSocket","addEventListener","event","send"],"sources":["/home/johan/dev/github/colonyos/dashboard/dashboard/src/colonies/colonyruntime.js"],"sourcesContent":["const input = 0\nconst output = 1\nconst err = 2\nconst env = 3\n\nclass ColonyRuntime {\n    constructor(host, port) {\n        this.crypto = new Crypto()\n        this.host = host\n        this.port = port\n    }\n\n    load() {\n        var crypto = this.crypto\n        let promise = new Promise(function(ok, err) {\n            crypto.load().then(() => {\n                ok()\n            })\n        })\n        return promise\n    }\n\n    crypto() {\n        return this.crypto\n    }\n\n    sendRPCMsg(msg, prvkey) {\n        let rpcMsg = {\n            \"payloadtype\": msg.msgtype,\n            \"payload\": \"\",\n            \"signature\": \"\"\n        }\n\n        rpcMsg.payload = btoa(JSON.stringify(msg))\n        rpcMsg.signature = this.crypto.sign(rpcMsg.payload, prvkey)\n\n        var host = this.host\n        var port = this.port\n\n        let promise = new Promise(function(resolve, reject) {\n            $.ajax({\n                type: \"POST\",\n                url: \"http://\" + host + \":\" + port + \"/api\",\n                data: JSON.stringify(rpcMsg),\n                contentType: 'plain/text',\n                success: function(response) {\n                    let rpcReplyMsg = JSON.parse(response)\n                    let msg = JSON.parse(atob(JSON.parse(response).payload))\n                    if (rpcReplyMsg.error == true) {\n                        reject(msg)\n                    } else {\n                        resolve(msg)\n                    }\n                },\n                fail: function(xhr, status, error) {\n                    reject(atob(JSON.parse(response).payload))\n                }\n            })\n        })\n\n        return promise\n    }\n\n    add_colony(colony, prvkey) {\n        var msg = {\n            \"msgtype\": \"addcolonymsg\",\n            \"colony\": colony\n        }\n\n        return this.sendRPCMsg(msg, prvkey)\n    }\n\n    getColonies(prvkey) {\n        var msg = {\n            \"msgtype\": \"getcoloniesmsg\"\n        }\n\n        return this.sendRPCMsg(msg, prvkey)\n    }\n\n    getColony(colonyid, prvkey) {\n        var msg = {\n            \"msgtype\": \"getcolonymsg\",\n            \"colonyid\": colonyid\n        }\n\n        return this.sendRPCMsg(msg, prvkey)\n    }\n\n    addRuntime(runtime, prvkey) {\n        var msg = {\n            \"msgtype\": \"addruntimemsg\",\n            \"runtime\": runtime\n        }\n\n        return this.sendRPCMsg(msg, prvkey)\n    }\n\n    rejectRuntime(runtimeid, prvkey) {\n        var msg = {\n            \"msgtype\": \"rejectruntimemsg\",\n            \"runtimeid\": runtimeid\n        }\n\n        return this.sendRPMsg(msg, prvkey)\n    }\n\n    approveRuntime(runtimeid, prvkey) {\n        var msg = {\n            \"msgtype\": \"approveruntimemsg\",\n            \"runtimeid\": runtimeid\n        }\n\n        return this.sendRPCMsg(msg, prvkey)\n    }\n\n    submitProcess_spec(spec, prvkey) {\n        var msg = {\n            \"msgtype\": \"submitprocessespecmsg\",\n            \"spec\": spec\n        }\n\n        return this.sendRPCMsg(msg, prvkey)\n    }\n\n    assign(colonyid, prvkey) {\n        var msg = {\n            \"msgtype\": \"assignprocessmsg\",\n            \"latest\": false,\n            \"timeout\": 1,\n            \"colonyid\": colonyid\n        }\n\n        return this.sendRPCMsg(msg, prvkey)\n    }\n\n    assignLatest(colonyid, prvkey) {\n        var msg = {\n            \"msgtype\": \"assignprocessmsg\",\n            \"latest\": true,\n            \"timeout\": -1,\n            \"colonyid\": colonyid\n        }\n\n        return this.sendRPCMsg(msg, prvkey)\n    }\n\n    addAttribute(attribute, prvkey) {\n        attribute.attributetype = output\n\n        var msg = {\n            \"msgtype\": \"addattributemsg\",\n            \"attribute\": attribute\n        }\n\n        return this.sendRPCMsg(msg, prvkey)\n    }\n\n    closeProcess(processid, successful, prvkey) {\n        var msg = {\n            \"msgtype\": \"closesuccessfulmsg\",\n            \"processid\": processid\n        }\n\n        if (successful) {\n            return this.sendRPCMsg(msg, prvkey)\n        }\n\n        msg.msgtype = \"closefailedfulmsg\"\n        return this.sendRPCMsg(msg, prvkey)\n    }\n\n    subscribeProcesses(runtimetype, timeout, state, prvkey, callback) {\n        var msg = {\n            \"msgtype\": \"subscribeprocessesmsg\",\n            \"runtimetype\": runtimetype,\n            \"state\": state,\n            \"timeout\": timeout\n        }\n\n        let rpcMsg = {\n            \"payloadtype\": msg.msgtype,\n            \"payload\": \"\",\n            \"signature\": \"\"\n        }\n\n        rpcMsg.payload = btoa(JSON.stringify(msg))\n        rpcMsg.signature = this.crypto.sign(rpcMsg.payload, prvkey)\n\n        let socket = new WebSocket(\"ws://\" + this.host + \":\" + this.port + \"/pubsub\");\n\n        socket.addEventListener('open', function(event) {\n            socket.send(JSON.stringify(rpcMsg));\n        });\n\n        let promise = new Promise(function(resolve, reject) {\n            socket.addEventListener('close', function(event) {\n                socket = null\n                reject()\n            });\n\n            socket.addEventListener('error', function(event) {\n                socket = null\n                reject()\n            });\n\n            socket.addEventListener('message', function(event) {\n                msg = JSON.parse(atob(JSON.parse(event.data).payload))\n                callback(msg)\n            });\n        })\n        return promise\n    }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}